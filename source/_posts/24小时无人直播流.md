---
title: 实现24小时无人直播流-一看就会
categories:
  - 干货
tags:
  - 24小时直播
abbrlink: 3766f053
date: 2024-06-16 01:18:21
---
# 24小时无人直播流

## 准备工作
* 获取直播平台的服务器地址和串流密钥（如B站）
* 一台服务器
* 会点linux命令

## 获取直播平台的服务器地址和串流密钥：如下图
![Bilibili](/img/local/25.png)




## 安装
1. 安装窗口管理工具
```bash
yum -y install screen
```
2. 创建ffmpeg目录
```bash
mkdir /root/lighhouse/ffmpeg
```
3. 去到目录下
```bash
cd /root/lighhouse
```
4. 开个新窗口
```bash
screen -S stream	#窗口名为stream
```
5、编辑脚本：
```bash
vim stream.sh
```
#脚本内容如下：
```bash
#!/bin/bash
PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin
export PATH
#=================================================================#
#   System Required: CentOS7 X86_64                               #
#   Description: FFmpeg Stream Media Server                       #
#   Author: LALA                                    #
#   Website: https://www.lala.im                                  #
#=================================================================#

# 颜色选择
red='\033[0;31m'
green='\033[0;32m'
yellow='\033[0;33m'
font="\033[0m"

ffmpeg_install(){
# 安装FFMPEG
read -p "你的机器内是否已经安装过FFmpeg4.x?安装FFmpeg才能正常推流,是否现在安装FFmpeg?(yes/no):" Choose
if [ $Choose = "yes" ];then
    yum -y install wget
    wget --no-check-certificate https://www.johnvansickle.com/ffmpeg/old-releases/ffmpeg-4.0.3-64bit-static.tar.xz
    tar -xJf ffmpeg-4.0.3-64bit-static.tar.xz
    cd ffmpeg-4.0.3-64bit-static
    mv ffmpeg /usr/bin && mv ffprobe /usr/bin && mv qt-faststart /usr/bin && mv ffmpeg-10bit /usr/bin
fi
if [ $Choose = "no" ]
then
    echo -e "${yellow} 你选择不安装FFmpeg,请确定你的机器内已经自行安装过FFmpeg,否则程序无法正常工作! ${font}"
    sleep 2
fi
    }

stream_start(){
# 定义推流地址和推流码
read -p "输入你的推流地址和推流码(rtmp协议):" rtmp

# 判断用户输入的地址是否合法
if [[ $rtmp =~ "rtmp://" ]];then
    echo -e "${green} 推流地址输入正确,程序将进行下一步操作. ${font}"
  	sleep 2
    else  
  	echo -e "${red} 你输入的地址不合法,请重新运行程序并输入! ${font}"
  	exit 1
fi 

# 定义视频存放目录
read -p "输入你的视频存放目录 (格式仅支持mp4,并且要绝对路径,例如/opt/video):" folder

# 判断是否需要添加水印
read -p "是否需要为视频添加水印?水印位置默认在右上方,需要较好CPU支持(yes/no):" watermark
if [ $watermark = "yes" ];then
    read -p "输入你的水印图片存放绝对路径,例如/opt/image/watermark.jpg (格式支持jpg/png/bmp):" image
    echo -e "${yellow} 添加水印完成,程序将开始推流. ${font}"
    # 循环
    while true
    do
        cd $folder
        for video in $(ls *.mp4)	#视频类型
        do
        #192k
        ffmpeg -re -i "$video" -i "$image" -filter_complex overlay=W-w-5:5 -c:v libx264 -c:a aac -b:a 192k -strict -2 -f flv ${rtmp}
        done
    done
fi
if [ $watermark = "no" ]
then
    echo -e "${yellow} 你选择不添加水印,程序将开始推流. ${font}"
    # 循环
    while true
    do
        cd $folder
        #for video in $(ls *.mp4)
        #do
        #ffmpeg -re -i "$video" -c:v copy -c:a aac -b:a 192k -strict -2 -f flv ${rtmp}
        #done
        video=$(find ./ -type f | shuf -n 1)
        #-preset这是指定编码速度和质量的预设。ultrafast 是速度最快的预设，但编码质量可能会稍微降低。
        #-g 60：设置关键帧间隔为 60 帧。关键帧是视频帧的一个特殊类型，用于保持视频的完整性，通常设置关键帧间隔可以影响视频的压缩效率和质量。
        #-vcodec：编码器 - libx264：264的编码器
        #-b:v 1500k：设置视频比特率为 1500 kbps，即视频的码率。
        ffmpeg -re -i "$video" -preset ultrafast -vcodec libx264 -g 60 -b:v 1500k -c:a aac -b:a 128k -strict -2 -f flv ${rtmp}
    done
fi
    }

# 停止推流
stream_stop(){
    screen -S stream -X quit
    killall ffmpeg
    }

# 开始菜单设置
echo -e "${yellow} CentOS7 X86_64 FFmpeg无人值守循环推流 For LALA.IM ${font}"
echo -e "${red} 请确定此脚本目前是在screen窗口内运行的! ${font}"
echo -e "${green} 1.安装FFmpeg (机器要安装FFmpeg才能正常推流) ${font}"
echo -e "${green} 2.开始无人值守循环推流 ${font}"
echo -e "${green} 3.停止推流 ${font}"
start_menu(){
    read -p "请输入数字(1-3),选择你要进行的操作:" num
    case "$num" in
        1)
        ffmpeg_install
        ;;
        2)
        stream_start
        ;;
        3)
        stream_stop
        ;;
        *)
        echo -e "${red} 请输入正确的数字 (1-3) ${font}"
        ;;
    esac
    }

# 运行开始菜单
start_menu
```

6、运行脚本
```bash
chmod +x stream.sh      # 给脚本执行权限
./stream.sh             # 运行脚本
```
7、使用说明
```
#执行脚本后弹出菜单，选择对应操作即可：
1) 先选择1 安装ffmpeg 
2) 安装ffmpeg后脚本会退出、再新建video目录存放需要播放的视频：

> mkdir /root/lighhouse/video

3) 再运行脚本后选择2 输入对应的配置：
   -- 提示 输入要直播平台的url地址和串流码：如B站：https://zxxx/串流码
   -- 输入视频存放的目录：/root/lighhouse/video
   -- 是否加水印：no
```

8. 这些都做完后既可以在B站看到自己的直播了：在另一个终端打开命令行执行
```bash
  -- screen -ls	#查看有几个进程和进程号
  -- screen -d 进程号.stream	#将进程脱离终端执行
```

9.注意视频文件要以mp4格式结尾、且要放在/root/lighhouse/video 该路径下

10. 退出直播可以执行：
```bash
screen -X -S 进程号.stream
```